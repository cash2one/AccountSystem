<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/md5.js"></script>
<script type="text/javascript" src="/js/util.js"></script>

<script type="text/javascript">
	PARAM_ARRAY = getHttpRequestParameters(window.location.href);
	CLIENT_ID = "";
	RESPONSE_TYPE = "";
	REDIRECT_URI = "";
	SCOPE = "";
	var i = 0;
	for (i = 0; i < PARAM_ARRAY.length; i++) {
		if (PARAM_ARRAY[i].key == "client_id") {
			CLIENT_ID = PARAM_ARRAY[i].value;
		} else if (PARAM_ARRAY[i].key == "response_type") {
			RESPONSE_TYPE = PARAM_ARRAY[i].value;
		} else if (PARAM_ARRAY[i].key == "redirect_uri") {
			REDIRECT_URI = PARAM_ARRAY[i].value;
		} else if (PARAM_ARRAY[i].key == "scope") {
			SCOPE = PARAM_ARRAY[i].value;
		}
		//alert(PARAM_ARRAY[i].key + ":" + PARAM_ARRAY[i].value);
	}
</script>
<title>Login</title>
</head>

<body>

<script type="text/javascript">
	function checkstat(stat){
	    if (stat.CAS_LOGIN_STATE=="") {
	    	// not login status 
	    	// TODO 
	    	// redirect also need to contains all the params
	    	var queries = "";
	    	for (var i = 0; i < PARAM_ARRAY.length; i++) {
	    		queries = queries + PARAM_ARRAY[i].key + "=" + PARAM_ARRAY[i].value + "&";
	    	}
	    	var returnURL = "http://account.grandmobile.cn/web/redirect?";
	    	returnURL += queries;
	        window.location.href="http://login.sdo.com/sdo/Login/LoginFrameFC.php?"
	        		+ "appId=917&"
	        		+ "areaId=1&"
	        		+ "customSecurityLevel=1&"
	        		+ "returnURL="
	        		+ encodeURIComponent(returnURL);
	    } else {
	    	// already login 
	    	alert(window.location.href);
	    	// if there is ticket in url, do validate.sigature to get sndaId 
	    	var validateUrl = "";
	    	for (i = 0; i < PARAM_ARRAY.length; i++) {
	    		if (PARAM_ARRAY[i].key == "ticket") {
	    			var timestamp = Math.ceil((new Date()).getTime() / 1000);
	    			var stringToSign = canonicalString("1", "917", "1", String(timestamp), String(PARAM_ARRAY[i].value));
	    			var hash = CryptoJS.MD5(stringToSign);
					validateUrl = makeSignedUrl("1", "917", "1",
							String(timestamp), String(PARAM_ARRAY[i].value),
							String(hash));
				}
			}
	    	
	    	var getAuthCodeUrl = "http://account.grandmobile.cn/api/oauth2/sdo_auth?";
	    	getAuthCodeUrl = getAuthCodeUrl + "client_id=" + CLIENT_ID + "&"
	    									+ "response_type=" + RESPONSE_TYPE + "&"
	    									+ "redirect_uri=" + REDIRECT_URI + "&"
	    									+ "scope=" + SCOPE + "&"
	    									+ "sdo_validate_url=" + encodeURIComponent(validateUrl);
	    	
	    	window.location.href=getAuthCodeUrl;
	    	
			// In this redirection, we can get the ticket from sdo 
			// take this ticket to access the next page to get the sndaId using validate interface 
			// TODO 
		}
	}
</script>

<iframe id="login_frame" scrolling="yes" frameborder="0" width="100%" height="100%"></iframe>
<script type="text/javascript" src="https://cas.sdo.com/cas/loginStateService?method=checkstat"></script>
</body>
</html>